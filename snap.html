<!DOCTYPE html>
<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script>
            $(document).ready(function(){
                const vid = document.querySelector('video');
                navigator.mediaDevices.getUserMedia({video: true}) // request cam
                    .then(stream => {
                        vid.srcObject = stream; // don't use createObjectURL(MediaStream)
                        return vid.play(); // returns a Promise
                    })
                    .then(()=>{ // enable the button
                        const btn = document.querySelector('button');
                        btn.disabled = false;
                        btn.onclick = e => {
                            takeASnap()
                                .then(download);
                        };
                    });

                function takeASnap(){
                    ratio = 1.3333333333333333;
                    left = ((ratio - 1) / (2 * ratio))
                    right = 100 - left

                    const canvas = document.getElementById('snap'); // create a canvas
                    var apostel = document.getElementById('apostle');
                    const ctx = canvas.getContext('2d'); // get its context
                    sx = Math.round(vid.videoWidth * left)
                    sy = 0
                    sWidth = Math.round(vid.videoWidth / ratio);
                    sHeight = vid.videoHeight;
                    dx = 0
                    dy = 0
                    dWidth = sWidth;
                    dHeight = sHeight;

                    canvas.width = vid.videoWidth / ratio;
                    canvas.height = vid.videoHeight;

                    canvas.style.border = '1 solid black';
                    ctx.imageSmoothingEnabled = false;
                    if (dHeight < 1000) {
                        apostel = scaleIt(apostel, 0.5)
                    }
                    ctx.drawImage(vid, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight); // the video
                    ctx.drawImage(apostel, 0, 0, dWidth, dHeight);
                    return new Promise((res, rej)=>{
                        canvas.toBlob(res, 'image/jpeg'); // request a Blob from the canvas
                    });
                }
                function scaleIt(source,scaleFactor){
                    var c=document.createElement('canvas');
                    var ctx=c.getContext('2d');
                    var w=source.width*scaleFactor;
                    var h=source.height*scaleFactor;
                    c.width=w;
                    c.height=h;
                    console.log(w);
                    console.log(h);
                    ctx.drawImage(source,0,0,w,h);
                    return(c);
                }
                function download(blob){
                    // uses the <a download> to download a Blob
                    let a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = 'screenshot.jpg';
                    document.body.appendChild(a);
                    a.click();
                }
            });
        </script>
    </head>
    <body>
        <button disabled>
            take a snapshot</button>
        <video></video>
        <canvas id="snap"></canvas>
        <img id="apostle" src="apostles/2.png" />
    </body>
</html>